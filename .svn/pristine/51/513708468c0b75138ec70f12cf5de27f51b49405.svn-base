//package com.hd.microblog.web.controller.api;
//
//import java.io.IOException;
//import java.util.Date;
//import java.util.List;
//import java.util.Map;
//
//import javax.servlet.http.HttpServletRequest;
//import javax.servlet.http.HttpServletResponse;
//import javax.servlet.http.HttpSession;
//
//import net.sf.json.JSONObject;
//
//import org.springframework.beans.factory.annotation.Autowired;
//import org.springframework.beans.factory.annotation.Qualifier;
//import org.springframework.stereotype.Controller;
//import org.springframework.web.bind.annotation.RequestMapping;
//import org.springframework.web.bind.annotation.ResponseBody;
//
//import com.hd.microblog.model.dt_chongzhi;
//import com.hd.microblog.model.dt_user;
//import com.hd.microblog.model.dt_usermoney;
//import com.hd.microblog.service.dt_chongzhiService;
//import com.hd.microblog.service.dt_taskService;
//import com.hd.microblog.service.dt_userService;
//import com.hd.microblog.service.dt_usermoneyService;
//import com.hd.microblog.web.controller.weixin.ServerConfig;
//import com.hd.microblog.web.controller.weixin.WeixinUtil;
//
//
//
//@Controller
//public class WXPayAPIController {
//	
//	@Autowired
//	@Qualifier("dt_userService")
//	private dt_userService dt_userservice;
//	@Autowired
//	@Qualifier("dt_usermoneyService")
//	private dt_usermoneyService dt_usermoneyservice;
//	@Autowired
//	@Qualifier("dt_taskService")
//	private dt_taskService dt_taskservice;
//	@Autowired
//	@Qualifier("dt_chongzhiService")
//	private dt_chongzhiService dt_chongzhiservice;
//	
//	
//	//微信支付
//	@RequestMapping(value = "/wxpay", produces = "application/json; charset=utf-8")
//	@ResponseBody
//	private String wxpay(HttpServletRequest request, HttpServletResponse resp,
//			Integer u_id,Float money) throws IOException {
//		resp.setHeader("Access-Control-Allow-Origin", "*");
//		resp.setHeader("Access-Control-Allow-Methods", "GET,POST");
//		JSONObject json = new JSONObject();
//		try{
//			//Float money2 = money/100;
//			//生成支付单号
//			int sjcode = (int) (Math.random()*9000+1000);
//			String order_code = String.valueOf(System.currentTimeMillis() / 1000)+sjcode;
//			//保存充值订单信息
//			dt_chongzhi chongzhi = new dt_chongzhi();
//			chongzhi.setU_id(u_id);
//			chongzhi.setPaynum(order_code);
//			chongzhi.setMoney(money);
//			chongzhi.setStatus(0);
//			chongzhi.setCreatetime(Integer.valueOf(String.valueOf(System.currentTimeMillis() / 1000)));
//			chongzhi.setType(1);
//			dt_chongzhiservice.saveOrUpdate(chongzhi);
//			float amount = money;//待支付金额
//			String goods_desc = "小白用户充值";//说明
//			String pay_notify = ServerConfig.getPaynotify()+"payreturn";//支付完成回调接口
//			Map<String, String> wxPayRespMap = WeixinUtil.configPayParam(request, order_code, amount, null, goods_desc, pay_notify);
//			json.putAll(wxPayRespMap);
//		}catch(Exception e){
//			e.printStackTrace();
//		}
//		return json.toString();
//	}
//	//回调
//	@RequestMapping(value = "/payreturn", produces = "application/json; charset=utf-8")
//	@ResponseBody
//	public String payreturn(HttpServletRequest request, HttpServletResponse resp) throws IOException {
//		resp.setHeader("Access-Control-Allow-Origin", "*");
//		resp.setHeader("Access-Control-Allow-Methods", "GET,POST");
//		JSONObject json = new JSONObject();
//		try{
//			List list = dt_chongzhiservice.apifindchongzhilistreturn();
//			for(int i=0;i<list.size();i++) {
//				Map map = (Map)list.get(i);
//				dt_chongzhi chongzhi = dt_chongzhiservice.get(Integer.valueOf(String.valueOf(map.get("ch_id"))));
//				Map<String, String> wxPayRespMap = WeixinUtil.wxpayquery(request,chongzhi.getPaynum());
//				if(String.valueOf(wxPayRespMap.get("trade_state")).equals("SUCCESS")){
//					chongzhi.setStatus(1);
//					dt_chongzhiservice.saveOrUpdate(chongzhi);
//					Integer u_id = Integer.valueOf(String.valueOf(map.get("u_id")));
//					Double money = Double.valueOf(String.valueOf(map.get("money")));
//					//查询用户信息
//					dt_user user = dt_userservice.get(u_id);
//					user.setMoney(user.getMoney()+money);
//					user.setMoneycount(user.getMoneycount()+money);
//					dt_userservice.saveOrUpdate(user);
//					//保存充值信息
//					dt_usermoney usermoney = new dt_usermoney();
//					usermoney.setU_id(u_id);
//					usermoney.setMoney(money*100);
//					usermoney.setInfo("用户充值"+money+"元成功");
//					usermoney.setType(7);
//					usermoney.setCreatetime(Integer.valueOf(String.valueOf(System.currentTimeMillis() / 1000)));
//					dt_usermoneyservice.saveOrUpdate(usermoney);
//				}
//			}
//			json.put("code", "100");
//			json.put("info", "回调成功");
//		}catch(Exception e){
//			e.printStackTrace();
//			json.put("code", "400");
//			json.put("info", "系统错误");
//		}
//		return json.toString();
//	}
//}
//
//
//
//
//
//
//
//
//
